<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>АгроМир - Главная</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/index.css">
    <link rel="stylesheet" href="/styles/chat.css"> <!-- Подключаем стили чата -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="background"></div>

    <header>
        <div class="auth-section">
            <% if (user) { %>
                <div class="user-profile">
                    <img src="<%= user.avatar_url || 'https://via.placeholder.com/30x30?text=Avatar' %>" alt="Аватар" class="avatar">
                    <span><%= user.email %></span>
                    <button class="logout-btn" onclick="window.location.href='/logout'">Выйти</button>
                </div>
            <% } else { %>
                <a href="/login" class="auth-btn">Вход</a> | <a href="/register" class="auth-btn">Регистрация</a>
            <% } %>
        </div>
    </header>

    <nav class="sidebar">
        <img src="/logo.png" alt="Логотип АгроМир" class="logo">
        <ul>
            <li><a href="/">Главная</a></li>
            <li><a href="/catalog">Каталог товаров</a></li>
            <li><a href="/cart">Корзина</a></li>
            <li><a href="/profile">Личный кабинет</a></li>
        </ul>
    </nav>

    <main class="content">
        <h1 class="page-title">Добро пожаловать в АгроМир!</h1>
        <p>Мы предлагаем широкий ассортимент товаров для вашего сада и огорода.</p>
        <a href="/catalog" class="btn">Перейти в каталог</a>
    </main>

    <!-- Чат-бот -->
    <div class="chat-container minimized">
        <div class="chat-header">
            <span>Чат с ботом</span>
            <button class="chat-toggle-btn">−</button>
        </div>
        <div class="chat-body" id="chat">
            <!-- Сообщения будут добавляться сюда -->
        </div>
        <div class="chat-footer">
            <div class="chat-buttons" id="chatButtons"></div>
            <div class="chat-input" id="chatInput">
                <input type="text" id="inputField" placeholder="Введи данные...">
                <button onclick="submitInput()">Отправить</button>
                <button onclick="cancelAction()" class="cancel-btn">Отмена</button>
            </div>
        </div>
    </div>
    <button class="chat-open-btn"><i class="fas fa-comment"></i> Чат</button>   

    <footer>
        <p>© 2025 АгроМир. Все права защищены.</p>
    </footer>

    <!-- Подключение Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        if (typeof io === 'undefined') {
            console.error('Socket.IO не загружен. Проверьте подключение скрипта /socket.io/socket.io.js');
        } else {
            const socket = io();
            const chatContainer = document.querySelector('.chat-container');
            const chatBody = document.getElementById('chat');
            const chatToggleBtn = document.querySelector('.chat-toggle-btn');
            const chatOpenBtn = document.querySelector('.chat-open-btn');

            // Функция для открытия/закрытия чата
            function toggleChat() {
                chatContainer.classList.toggle('minimized');
            }

            // Отображение сообщений
            socket.on('response', (msg) => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', 'bot-message');
                messageElement.innerHTML = msg;
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
            });

            // Отображение кнопок
            socket.on('show_buttons', (buttons) => {
                const chatButtons = document.getElementById('chatButtons');
                const chatInput = document.getElementById('chatInput');
                chatButtons.style.display = 'flex';
                chatInput.style.display = 'none';
                chatButtons.innerHTML = ''; // Очищаем предыдущие кнопки
                buttons.forEach(button => {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = button.text;
                    buttonElement.onclick = () => {
                        socket.emit('button_click', button.value);
                    };
                    chatButtons.appendChild(buttonElement);
                });
                // Добавляем кнопку "Отмена", если это не начальное меню
                if (buttons.length < 3) { // Начальное меню имеет 3 кнопки, остальные случаи — меньше
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Отмена';
                    cancelButton.classList.add('cancel-btn');
                    cancelButton.onclick = () => {
                        socket.emit('cancel_action');
                    };
                    chatButtons.appendChild(cancelButton);
                }
            });

            // Показ поля ввода
            socket.on('show_input', (options) => {
                console.log('Получено событие show_input:', options); // Отладка
                const chatButtons = document.getElementById('chatButtons');
                const chatInput = document.getElementById('chatInput');
                const inputField = document.getElementById('inputField');
                chatButtons.style.display = 'none';
                chatInput.style.display = 'flex';
                inputField.placeholder = options.placeholder || 'Введи данные...';
                inputField.focus();
            });

            // Отправка введённых данных
            function submitInput() {
                const inputField = document.getElementById('inputField');
                const message = inputField.value.trim();
                if (message) {
                    console.log('Отправка input_submit:', message); // Отладка
                    socket.emit('input_submit', message);
                    inputField.value = '';
                }
            }

            // Отмена действия
            function cancelAction() {
                console.log('Отправка cancel_action'); // Отладка
                socket.emit('cancel_action');
            }

            // Отправка данных по нажатию Enter
            document.getElementById('inputField').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    console.log('Нажата клавиша Enter'); // Отладка
                    submitInput();
                }
            });

            // Показать/скрыть чат
            chatToggleBtn.addEventListener('click', () => {
                console.log('Сворачивание/разворачивание чата');
                toggleChat();
            });

            chatOpenBtn.addEventListener('click', () => {
                console.log('Открытие чата');
                toggleChat();
            });
        }
    </script>
</body>
</html>